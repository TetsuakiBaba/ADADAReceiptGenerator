<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Conference Receipt PDF Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b0c10;
            --card: #ffffff;
            --ink: #0f172a;
            --muted: #475569;
            --brand: #0ea5e9;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
            background: var(--bg);
            color: #111;
        }

        .wrap {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 16px;
            padding: 16px;
        }

        @media (max-width: 980px) {
            .wrap {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: var(--card);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, .12);
        }

        .panel h1 {
            margin: 0 0 12px;
            font-size: 20px;
            color: #0f172a;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        label {
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 4px;
            display: block;
        }

        input[type="text"],
        input[type="date"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 14px;
            outline: none;
        }

        textarea {
            resize: vertical;
            min-height: 72px;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .btn {
            appearance: none;
            border: none;
            border-radius: 12px;
            padding: 10px 14px;
            background: var(--brand);
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .btn.secondary {
            background: #111827;
        }

        .muted {
            color: var(--muted);
            font-size: 12px;
        }

        .preview {
            height: calc(100vh - 32px);
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }

        .spacer {
            flex: 1;
        }

        iframe {
            width: 100%;
            flex: 1;
            border: none;
            background: white;
            border-radius: 12px;
            box-shadow: inset 0 0 0 1px #e5e7eb;
        }

        .inline {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .note {
            background: #f1f5f9;
            border: 1px dashed #cbd5e1;
            padding: 10px;
            border-radius: 10px;
            color: #0f172a;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <!-- Controls -->
        <section class="panel">
            <h1>Receipt Details</h1>
            <div class="grid">
                <div>
                    <label for="org">Association / Organization Name</label>
                    <input id="org" type="text" placeholder="Asia Digital Art and Design Association (ADADA)" />
                </div>
                <div class="row">
                    <div>
                        <label for="rep">Representative Name / Title</label>
                        <input id="rep" type="text" placeholder="Tetsuaki Baba, President" />
                    </div>
                    <div>
                        <label for="date">Receipt Date</label>
                        <input id="date" type="date" />
                    </div>
                </div>
                <div class="row">
                    <div>
                        <label for="amount">Amount</label>
                        <input id="amount" type="number" step="0.01" placeholder="200" />
                    </div>
                    <div>
                        <label for="currency">Currency</label>
                        <select id="currency">
                            <option value="JPY">JPY</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                            <option value="AED">AED</option>
                            <option value="GBP">GBP</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="desc">Purpose / Description</label>
                    <input id="desc" type="text" placeholder="ADADA+CUMULUS 2025 Conference Registration Fee" />
                </div>
                <div>
                    <label for="to">Received From ( Name / Affiliation)</label>
                    <input id="to" type="text" placeholder="Dr. Jane Doe, University of Example" />
                </div>
                <div class="row">
                    <div>
                        <label for="place">Place of Issue (optional)</label>
                        <input id="place" type="text" placeholder="Tokyo, Japan" />
                    </div>
                    <div>
                        <label for="ref">Reference / Notes (optional)</label>
                        <input id="ref" type="text" placeholder="Registration ID: ADADA-2025-00123" />
                    </div>
                </div>
                <div>
                    <label for="stamp">Seal / Stamp Image (PNG recommended, transparent)</label>
                    <input id="stamp" type="file" accept="image/*" />
                    <div class="note" style="margin-top:6px">
                        You may also provide <b>stampUrl</b> via GET parameter to load an image from a URL (CORS must
                        allow it).
                    </div>
                </div>

                <div class="row" style="margin-top:8px">
                    <button id="download" class="btn">Download PDF</button>
                    <button id="copylink" class="btn secondary" title="Copy a shareable link with GET parameters">Copy
                        Share Link</button>
                </div>
                <div>
                    <span class="muted">The preview updates automatically as you type.</span>
                </div>
            </div>
        </section>

        <!-- PDF Preview -->
        <section class="panel preview">
            <div class="toolbar">
                <div class="inline">
                    <strong>PDF Preview</strong>
                </div>
                <div class="spacer"></div>
                <div class="muted">A4 • 1 page • English format</div>
            </div>
            <iframe id="pdfFrame" title="PDF Preview"></iframe>
        </section>
    </div>

    <!-- jsPDF CDN -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script>
        const $ = (id) => document.getElementById(id);

        const fields = ["org", "rep", "date", "amount", "currency", "desc", "to", "place", "ref"];
        let stampImageDataUrl = null; // base64 data URL of the stamp

        // Load GET params → set fields
        function loadFromParams() {
            const p = new URLSearchParams(location.search);
            fields.forEach(k => { if (p.has(k)) $(k).value = decodeURIComponent(p.get(k)); });
            if (p.has('stampUrl')) {
                const url = p.get('stampUrl');
                fetchImageAsDataURL(url).then(d => { stampImageDataUrl = d; render(); }).catch(() => { });
            }
            // Default date to today if empty
            if (!$("date").value) {
                const t = new Date();
                const y = t.getFullYear();
                const m = String(t.getMonth() + 1).padStart(2, '0');
                const d = String(t.getDate()).padStart(2, '0');
                $("date").value = `${y}-${m}-${d}`;
            }
        }

        // Build a shareable link
        function buildShareURL() {
            const p = new URLSearchParams();
            fields.forEach(k => { const v = $(k).value.trim(); if (v) p.set(k, v); });
            // We do not inline the uploaded file; suggest using stampUrl if needed
            const u = `${location.origin}${location.pathname}?${p.toString()}`;
            return u;
        }

        async function fetchImageAsDataURL(url) {
            const res = await fetch(url, { mode: 'cors' });
            const blob = await res.blob();
            return await new Promise((resolve) => { const r = new FileReader(); r.onload = () => resolve(r.result); r.readAsDataURL(blob); });
        }

        // Handle stamp upload
        $("stamp").addEventListener('change', (e) => {
            const f = e.target.files?.[0];
            if (!f) { stampImageDataUrl = null; render(); return; }
            const r = new FileReader();
            r.onload = () => { stampImageDataUrl = r.result; render(); }
            r.readAsDataURL(f);
        });

        // Render PDF and show in iframe
        async function render() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'mm', format: 'a4' });

            const marginX = 18; // left/right
            const line = (y) => doc.line(marginX, y, 210 - marginX, y);

            // Colors / fonts
            doc.setTextColor(20, 28, 38); // slate-900

            // Title
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(20);
            doc.text('RECEIPT', 105, 22, { align: 'center' });

            // Org + meta area
            const org = $("org").value || '';
            const rep = $("rep").value || '';
            const date = $("date").value || '';
            const place = $("place").value || '';
            const topY = 32;
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            const orgBlock = [
                org ? org : '',
                rep ? `Representative: ${rep}` : '',
                place ? `Place of Issue: ${place}` : ''
            ].filter(Boolean).join("\n");
            doc.text(orgBlock, marginX, topY);

            // Date on right
            if (date) { doc.text(`Date: ${date}`, 210 - marginX, topY, { align: 'right' }); }

            line(43);

            // Bill To
            const to = $("to").value || '';
            doc.setFont('helvetica', 'bold');
            doc.text('RECEIVED FROM', marginX, 48);
            doc.setFont('helvetica', 'normal');
            doc.text(to || '-', marginX, 54);

            // Description & Amount box
            const desc = $("desc").value || '';
            const amount = $("amount").value ? Number($("amount").value).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00';
            const currency = $("currency").value || 'JPY';

            // Amount big box
            const boxTop = 66;
            const boxH = 32;
            const boxW = 210 - marginX * 2;
            doc.setLineWidth(0.4);
            doc.roundedRect(marginX, boxTop, boxW, boxH, 2, 2);

            // Left: Description
            doc.setFont('helvetica', 'bold');
            doc.text('Purpose / Description', marginX + 4, boxTop + 7);
            doc.setFont('helvetica', 'normal');
            const descText = desc || '-';
            doc.text(doc.splitTextToSize(descText, boxW - 80), marginX + 4, boxTop + 14);

            // Right: Amount
            doc.setFont('helvetica', 'bold');
            doc.text('Amount', 210 - marginX - 70 + 4, boxTop + 7);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(18);
            doc.text(`${currency} ${amount}`, 210 - marginX - 6, boxTop + 22, { align: 'right' });
            doc.setFontSize(11);

            // Notes / reference
            const ref = $("ref").value || '';
            if (ref) {
                doc.setFont('helvetica', 'bold');
                doc.text('Reference / Notes', marginX, boxTop + boxH + 10);
                doc.setFont('helvetica', 'normal');
                doc.text(doc.splitTextToSize(ref, boxW), marginX, boxTop + boxH + 16);
            }

            // Signature block
            const sigTop = ref ? boxTop + boxH + 36 : boxTop + boxH + 20;
            doc.setFont('helvetica', 'bold');
            doc.text('Authorized Signature / Seal', marginX, sigTop);
            doc.setFont('helvetica', 'normal');
            doc.text(`${org || ''}`, marginX, sigTop + 8);
            if (rep) { doc.text(`${rep}`, marginX, sigTop + 14); }

            // Stamp image near signature (optional)
            if (stampImageDataUrl) {
                try {
                    // Place at right side of signature area
                    const imgW = 36; // mm
                    const imgH = 36;
                    doc.addImage(stampImageDataUrl, 'PNG', 210 - marginX - imgW, sigTop - 6, imgW, imgH, undefined, 'FAST');
                } catch (e) { /* ignore */ }
            }

            // Footer note
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(71, 85, 105);
            doc.setFontSize(9);
            doc.text('This receipt certifies that the above amount has been received for the stated purpose by the issuing organization.', 105, 286, { align: 'center' });

            // Output to preview iframe
            const blob = doc.output('blob');
            const url = URL.createObjectURL(blob);
            const frame = $("pdfFrame");
            frame.src = url;

            // keep reference to revoke when re-rendering
            if (render._prev) { URL.revokeObjectURL(render._prev); }
            render._prev = url;

            return doc; // so we can also download from latest render
        }

        // Debounce helper
        function debounce(fn, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; }
        const renderDebounced = debounce(render, 180);

        // Wire inputs → live render + update URL (without reload)
        function wireInputs() {
            fields.forEach(id => {
                $(id).addEventListener('input', () => {
                    renderDebounced();
                    const u = buildShareURL();
                    history.replaceState(null, '', u);
                });
            });
        }

        // Download current PDF
        $("download").addEventListener('click', async () => {
            const doc = await render();
            const org = ("" + $("org").value).trim() || 'Organization';
            const to = ("" + $("to").value).trim() || 'Recipient';
            const date = ("" + $("date").value).trim() || 'date';
            const safe = (s) => s.replace(/[^a-z0-9\-_.]+/gi, '_');
            doc.save(`Receipt_${safe(org)}_${safe(to)}_${safe(date)}.pdf`);
        });

        // Copy share link
        $("copylink").addEventListener('click', async () => {
            const url = buildShareURL();
            try { await navigator.clipboard.writeText(url); alert('Share link copied to clipboard!'); }
            catch (e) { prompt('Copy this URL:', url); }
        });

        // Init
        loadFromParams();
        wireInputs();
        render();
    </script>
</body>

</html>